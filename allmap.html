<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>全体マップ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
    
    <!-- PWA用のmeta設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- style sheet-->
    <link rel="stylesheet" href="./allmap.css">
</head>

<body>
    <div id="map_screen">
        <!-- 上部の説明文 -->
        <div id="top_description">
            📍 新潟工科大学キャンパスマップ
        </div>
        
        <!-- マップ本体 -->
        <div id="map"></div>
        
        <!-- 下部の説明文 -->
        <div id="bottom_description">
            位置情報がスタンプラリー実施場所から300m以内に入ると自動的に構内マップに切り替わります<br>
            地図上のピンをタップすることでも構内マップに切り替わります
        </div>
    </div>

    <script>
        // ビューポートの高さを動的に調整する関数
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // 初期設定とリサイズ時の調整
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', () => {
            setTimeout(setViewportHeight, 100);
        });

        // DOM読み込み完了後に実行
        document.addEventListener('DOMContentLoaded', function() {
            // ビューポート高さを再調整
            setTimeout(setViewportHeight, 100);
            
            // 下部説明文の要素を取得（最初に取得）
            const bottomDesc = document.getElementById('bottom_description');
            
            // デバッグ用のログ出力
            console.log('下部説明文要素:', bottomDesc);
            console.log('要素のスタイル:', bottomDesc ? window.getComputedStyle(bottomDesc) : 'null');
            console.log('要素の位置:', bottomDesc ? bottomDesc.getBoundingClientRect() : 'null');
            
            // 要素が存在することを確認
            if (bottomDesc) {
                bottomDesc.textContent = "テスト：この文字が見えますか？";
                bottomDesc.style.display = "flex";
                bottomDesc.style.visibility = "visible";
                console.log('下部説明文を設定しました');
            } else {
                console.error('下部説明文の要素が見つかりません！');
                return;
            }
            
            // マップ設定
            const niitechLatLng = [37.339278, 138.578972];
            const map = L.map('map').setView(niitechLatLng, 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            const niitechMarker = L.marker(niitechLatLng).addTo(map)
                .bindPopup("新潟工科大学<br>クリックで構内マップへ")
                .on('click', () => {
                    location.href = "app_screen.html";
                });

            // 現在地取得して300m以内なら自動で切替
            if ("geolocation" in navigator) {
                bottomDesc.textContent = "位置情報を取得中...";
                bottomDesc.style.backgroundColor = "#fff3cd";
                bottomDesc.style.color = "#856404";
                
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const distance = map.distance([lat, lng], niitechLatLng);

                    const redIcon = L.divIcon({ className: 'current-location-pin' });
                    L.marker([lat, lng], { icon: redIcon }).addTo(map).bindPopup("現在地").openPopup();

                    // 距離に応じて下部の説明文を更新
                    if (distance <= 300) {
                        bottomDesc.textContent = "キャンパス内にいます！構内マップに自動切替します...";
                        bottomDesc.style.backgroundColor = "#d4edda";
                        bottomDesc.style.color = "#155724";
                        setTimeout(() => {
                            location.href = "app_screen.html";
                        }, 2000);
                    } else {
                        const distanceKm = (distance / 1000).toFixed(1);
                        bottomDesc.textContent = `新潟工科大学まで約${distanceKm}km離れています`;
                        bottomDesc.style.backgroundColor = "#f8f9fa";
                        bottomDesc.style.color = "#666";
                    }
                },
                (error) => {
                    console.error('位置情報取得エラー:', error);
                    bottomDesc.textContent = "位置情報の取得に失敗しました。手動でマーカーをクリックしてください。";
                    bottomDesc.style.backgroundColor = "#f8d7da";
                    bottomDesc.style.color = "#721c24";
                });
            } else {
                bottomDesc.textContent = "この端末では位置情報が利用できません。";
                bottomDesc.style.backgroundColor = "#fff3cd";
                bottomDesc.style.color = "#856404";
            }

            // マップサイズの調整
            setTimeout(() => {
                map.invalidateSize();
                // 下部説明文の再確認
                console.log('マップ調整後の下部説明文:', bottomDesc.getBoundingClientRect());
            }, 300);
        });
    </script>
</body>
</html>
