<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>å…¨ä½“ãƒãƒƒãƒ—</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
    
    <!-- PWAç”¨ã®metaè¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- style sheet-->
    <link rel="stylesheet" href="./allmap.css">
</head>

<body>
    <div id="map_screen">
        <!-- ä¸Šéƒ¨ã®èª¬æ˜æ–‡ -->
        <div id="top_description">
            ğŸ“ æ–°æ½Ÿå·¥ç§‘å¤§å­¦ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒãƒƒãƒ—
        </div>
        
        <!-- ãƒãƒƒãƒ—æœ¬ä½“ -->
        <div id="map"></div>
        
        <!-- ä¸‹éƒ¨ã®èª¬æ˜æ–‡ -->
        <div id="bottom_description">
            ä½ç½®æƒ…å ±ãŒã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼å®Ÿæ–½å ´æ‰€ã‹ã‚‰300mä»¥å†…ã«å…¥ã‚‹ã¨è‡ªå‹•çš„ã«æ§‹å†…ãƒãƒƒãƒ—ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™<br>
            åœ°å›³ä¸Šã®ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã‚‚æ§‹å†…ãƒãƒƒãƒ—ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™
        </div>
    </div>

    <script>
        // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã‚’å‹•çš„ã«èª¿æ•´ã™ã‚‹é–¢æ•°
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // åˆæœŸè¨­å®šã¨ãƒªã‚µã‚¤ã‚ºæ™‚ã®èª¿æ•´
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', () => {
            setTimeout(setViewportHeight, 100);
        });

        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã‚’å†èª¿æ•´
            setTimeout(setViewportHeight, 100);
            
            // ä¸‹éƒ¨èª¬æ˜æ–‡ã®è¦ç´ ã‚’å–å¾—ï¼ˆæœ€åˆã«å–å¾—ï¼‰
            const bottomDesc = document.getElementById('bottom_description');
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°å‡ºåŠ›
            console.log('ä¸‹éƒ¨èª¬æ˜æ–‡è¦ç´ :', bottomDesc);
            console.log('è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«:', bottomDesc ? window.getComputedStyle(bottomDesc) : 'null');
            console.log('è¦ç´ ã®ä½ç½®:', bottomDesc ? bottomDesc.getBoundingClientRect() : 'null');
            
            // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            if (bottomDesc) {
                bottomDesc.textContent = "ãƒ†ã‚¹ãƒˆï¼šã“ã®æ–‡å­—ãŒè¦‹ãˆã¾ã™ã‹ï¼Ÿ";
                bottomDesc.style.display = "flex";
                bottomDesc.style.visibility = "visible";
                console.log('ä¸‹éƒ¨èª¬æ˜æ–‡ã‚’è¨­å®šã—ã¾ã—ãŸ');
            } else {
                console.error('ä¸‹éƒ¨èª¬æ˜æ–‡ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
                return;
            }
            
            // ãƒãƒƒãƒ—è¨­å®š
            const niitechLatLng = [37.339278, 138.578972];
            const map = L.map('map').setView(niitechLatLng, 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            const niitechMarker = L.marker(niitechLatLng).addTo(map)
                .bindPopup("æ–°æ½Ÿå·¥ç§‘å¤§å­¦<br>ã‚¯ãƒªãƒƒã‚¯ã§æ§‹å†…ãƒãƒƒãƒ—ã¸")
                .on('click', () => {
                    location.href = "app_screen.html";
                });

            // ç¾åœ¨åœ°å–å¾—ã—ã¦300mä»¥å†…ãªã‚‰è‡ªå‹•ã§åˆ‡æ›¿
            if ("geolocation" in navigator) {
                bottomDesc.textContent = "ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...";
                bottomDesc.style.backgroundColor = "#fff3cd";
                bottomDesc.style.color = "#856404";
                
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const distance = map.distance([lat, lng], niitechLatLng);

                    const redIcon = L.divIcon({ className: 'current-location-pin' });
                    L.marker([lat, lng], { icon: redIcon }).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();

                    // è·é›¢ã«å¿œã˜ã¦ä¸‹éƒ¨ã®èª¬æ˜æ–‡ã‚’æ›´æ–°
                    if (distance <= 300) {
                        bottomDesc.textContent = "ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹å†…ã«ã„ã¾ã™ï¼æ§‹å†…ãƒãƒƒãƒ—ã«è‡ªå‹•åˆ‡æ›¿ã—ã¾ã™...";
                        bottomDesc.style.backgroundColor = "#d4edda";
                        bottomDesc.style.color = "#155724";
                        setTimeout(() => {
                            location.href = "app_screen.html";
                        }, 2000);
                    } else {
                        const distanceKm = (distance / 1000).toFixed(1);
                        bottomDesc.textContent = `æ–°æ½Ÿå·¥ç§‘å¤§å­¦ã¾ã§ç´„${distanceKm}kmé›¢ã‚Œã¦ã„ã¾ã™`;
                        bottomDesc.style.backgroundColor = "#f8f9fa";
                        bottomDesc.style.color = "#666";
                    }
                },
                (error) => {
                    console.error('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    bottomDesc.textContent = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚";
                    bottomDesc.style.backgroundColor = "#f8d7da";
                    bottomDesc.style.color = "#721c24";
                });
            } else {
                bottomDesc.textContent = "ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚";
                bottomDesc.style.backgroundColor = "#fff3cd";
                bottomDesc.style.color = "#856404";
            }

            // ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºã®èª¿æ•´
            setTimeout(() => {
                map.invalidateSize();
                // ä¸‹éƒ¨èª¬æ˜æ–‡ã®å†ç¢ºèª
                console.log('ãƒãƒƒãƒ—èª¿æ•´å¾Œã®ä¸‹éƒ¨èª¬æ˜æ–‡:', bottomDesc.getBoundingClientRect());
            }, 300);
        });
    </script>
</body>
</html>
